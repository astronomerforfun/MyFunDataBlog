<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Chris&#39;s Data Blog  | Google -- Thank you for giving us Tensorflow and Keras...</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.49.2" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.e08a958ae3e530145318b6373195c765.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="Google -- Thank you for giving us Tensorflow and Keras..." />
<meta property="og:description" content="Keras Deep Learning Neural Network by Chris Shockley" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/keras_ctg/script/" /><meta property="article:published_time" content="2018-11-10T10:58:08-04:00"/>
<meta property="article:modified_time" content="2018-11-10T10:58:08-04:00"/>

<meta itemprop="name" content="Google -- Thank you for giving us Tensorflow and Keras...">
<meta itemprop="description" content="Keras Deep Learning Neural Network by Chris Shockley">


<meta itemprop="datePublished" content="2018-11-10T10:58:08-04:00" />
<meta itemprop="dateModified" content="2018-11-10T10:58:08-04:00" />
<meta itemprop="wordCount" content="1445">



<meta itemprop="keywords" content="supervised learning,caret,machine learning,models,keras,tutorial,tensorflow," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Google -- Thank you for giving us Tensorflow and Keras..."/>
<meta name="twitter:description" content="Keras Deep Learning Neural Network by Chris Shockley"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  
  
  <header class="cover bg-top" style="background-image: url('/images/kerastensor.jpg');">
    <div class="pb3-m pb6-l bg-black-60">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      Chris&#39;s Data Blog
    </a>
    <div class="flex-l items-center">
      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about/" title="About page">
              About
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/contact/" title="Contact page">
              Contact
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/post/" title="Posts page">
              Posts
            </a>
          </li>
          
        </ul>
      
      


  <a href="fb.me/astronomerforfun" class="link-transition facebook link dib z-999 pt3 pt0-l mr2" title="Facebook link">
    <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

  </a>








    </div>
  </div>
</nav>

      <div class="tc-l pv6 ph3 ph4-ns">
        <h1 class="f2 f1-l fw2 white-90 mb0 lh-title">Google -- Thank you for giving us Tensorflow and Keras...</h1>
        
          <h2 class="fw1 f5 f3-l white-80 measure-wide-l center lh-copy mt3 mb4">
            Keras Deep Learning Neural Network by Chris Shockley
          </h2>
        
      </div>
    </div>
  </header>



    <main class="pb7" role="main">
      
  <article class="flex-l flex-wrap justify-between mw8 center ph3 ph0-l">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">Google -- Thank you for giving us Tensorflow and Keras...</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2018-11-10T10:58:08-04:00">November 10, 2018</time>
    </header>

    <main class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><div id="first-what-is-deep-learning" class="section level2">
<h2>First what is Deep Learning?</h2>
<p>Deep Learning. Uhhh… Hmmmm… Well… I know how to implement some of these deep(er) learning algorithms/models, but I’m just now getting my brain around how they work. So I’m coming clean (and I feel so much lighter). My thinking is if I test my model on new data (data the model hasn’t seen) many times over and get good results (that are measurable and repeatable) no need to be concerned with how the thing works under the hood? I digress. I promise once I can explain it to the layman I will write a post. At its basic nature though: It’s a model that predicts. And as it gets more data it gets smarter or more accurate. Here is a graph of that illustrates what’s going on… Again, I understand it theoretically but I still don’t have my arms around it.</p>
<div class="figure">
<img src="/images/nerual.jpg" alt="This is a Neural Networks on Movie Reviews." />
<p class="caption">This is a Neural Networks on Movie Reviews.</p>
</div>
<p>As it relates to R: Keras and Tensorflow (Google’s gift to the developers involved in Machine Learning - yes this is Google’s API, which FB and many other tech companies are using) has been limited to those that use Python (the enemy - just kidding). More recently R has joined the AI space so that’s cool – if you’re into R we can thank the developers that don’t have to learn another programming language to implement these Neural Networks.</p>
<div id="objective" class="section level4">
<h4>Objective:</h4>
<p>I am going to work train a Neural Network in R within Keras. The tutorial is meant for practice for me and a document of sorts. And for you too. If you’re interested follow along. The code will be in R of course.</p>
</div>
</div>
<div id="load-packages" class="section level2">
<h2>Load Packages</h2>
<pre class="r"><code>library(keras)
install_keras()</code></pre>
<pre><code>## Creating r-tensorflow conda environment for TensorFlow installation...
## 
## Installation complete.</code></pre>
<p><br></p>
</div>
<div id="load-the-data" class="section level2">
<h2>Load the Data</h2>
<p>I am using the CTG dataset. There are 21 independent variables and one dependent variable. This will be a classifcation problem. We are predicting whether the dependent variable is a 1,2, or 3.</p>
<pre class="r"><code>data &lt;- read.csv(&quot;CTG.csv&quot;, header = T)
head(data)</code></pre>
<pre><code>##    LB          AC FM          UC          DL DS          DP ASTV MSTV ALTV
## 1 120 0.000000000  0 0.000000000 0.000000000  0 0.000000000   73  0.5   43
## 2 132 0.006379585  0 0.006379585 0.003189793  0 0.000000000   17  2.1    0
## 3 133 0.003322259  0 0.008305648 0.003322259  0 0.000000000   16  2.1    0
## 4 134 0.002560819  0 0.007682458 0.002560819  0 0.000000000   16  2.4    0
## 5 132 0.006514658  0 0.008143322 0.000000000  0 0.000000000   16  2.4    0
## 6 134 0.001049318  0 0.010493179 0.009443861  0 0.002098636   26  5.9    0
##   MLTV Width Min Max Nmax Nzeros Mode Mean Median Variance Tendency NSP
## 1  2.4    64  62 126    2      0  120  137    121       73        1   2
## 2 10.4   130  68 198    6      1  141  136    140       12        0   1
## 3 13.4   130  68 198    5      1  141  135    138       13        0   1
## 4 23.0   117  53 170   11      0  137  134    137       13        1   1
## 5 19.9   117  53 170    9      0  137  136    138       11        1   1
## 6  0.0   150  50 200    5      3   76  107    107      170        0   3</code></pre>
<p><br></p>
</div>
<div id="proper-form" class="section level2">
<h2>Proper Form</h2>
<p>To get this in the proper form for Keras I need to convert it to a Matrix and then remove the column names.</p>
<pre class="r"><code>data &lt;- as.matrix(data)
dimnames(data) &lt;- NULL</code></pre>
<p><br></p>
<div id="normalization-and-other-things" class="section level4">
<h4>Normalization and Other Things</h4>
<p>For Keras to run the algorithm properly I must normalize all the independent variables/columns, with the exception of the dependent/response variable. That I am going to convert from a factor to a numeric.</p>
<pre class="r"><code>data[, 1:21] &lt;- normalize(data[,1:21])
data[,22] &lt;- as.numeric(data[,22])-1</code></pre>
<p><br></p>
</div>
<div id="create-test-and-training-set" class="section level4">
<h4>Create Test and Training Set</h4>
<p>Here I am going to create a Training and Test Set using a 70/30 split. Additionally I will store the dependent variable in its own object.</p>
<pre class="r"><code>set.seed(1234) #for reproducibility
ind &lt;- sample(2, nrow(data), replace = T, prob = c(.7,.3)) # This is new way of splitting data
training &lt;- data[ind == 1, 1:21] #Independent
test &lt;- data[ind==2, 1:21] #Independent
trainingtarget &lt;- data[ind == 1, 22] #dependent
testtarget &lt;- data[ind == 2, 22] #dependent</code></pre>
<p><br></p>
</div>
<div id="one-hot-encoding" class="section level4">
<h4>One Hot Encoding</h4>
<p>This is one of the crazy cool features of Keras. Basically it takes the dependent variable and expands it out so that each row has only a one “1”. Look at the first ten rows to see what it did. Basically were back to binary’s (1’s and 0’s )</p>
<pre class="r"><code>trainlabels &lt;- to_categorical(trainingtarget)
testlabels &lt;- to_categorical(testtarget)
head(trainlabels, 10)</code></pre>
<pre><code>##       [,1] [,2] [,3]
##  [1,]    0    1    0
##  [2,]    1    0    0
##  [3,]    1    0    0
##  [4,]    1    0    0
##  [5,]    0    0    1
##  [6,]    0    0    1
##  [7,]    0    0    1
##  [8,]    0    0    1
##  [9,]    0    0    1
## [10,]    0    1    0</code></pre>
<p><br></p>
</div>
<div id="model" class="section level4">
<h4>Model</h4>
<p>So this is going to be a Neural Network with two hidden layers. The more layers the more dense the neurality, so to speak, and the deeper the model. Of course the deeper the more computing power. I should be fine using my laptop here though.</p>
<p>Relu and Softmax are two of the most popular layers to use.</p>
<pre class="r"><code>model &lt;- keras_model_sequential()
model %&gt;%
  layer_dense(units = 8, activation = &quot;relu&quot;, input_shape = c(21))%&gt;%
  layer_dense(units = 3, activation = &quot;softmax&quot;)
summary(model)</code></pre>
<pre><code>## ___________________________________________________________________________
## Layer (type)                     Output Shape                  Param #     
## ===========================================================================
## dense_1 (Dense)                  (None, 8)                     176         
## ___________________________________________________________________________
## dense_2 (Dense)                  (None, 3)                     27          
## ===========================================================================
## Total params: 203
## Trainable params: 203
## Non-trainable params: 0
## ___________________________________________________________________________</code></pre>
<p><br></p>
</div>
</div>
<div id="learning" class="section level2">
<h2>Learning</h2>
<p>Now we’re going to set up the model itself.</p>
<pre class="r"><code>model %&gt;%
  compile(loss = &quot;categorical_crossentropy&quot;,
          optimizer = &quot;adam&quot;,
          metrics = &quot;accuracy&quot;)</code></pre>
<p><br></p>
</div>
<div id="fit-model" class="section level2">
<h2>Fit Model</h2>
<p>This is where we will fit the model. Notice that I reserved .2 as validation. So as it’s fitting the model it will be testing it against the validation portion. This will give us a good understanding of how it’s performing with the training set. See graph.</p>
<p>In the graph you can see at the top (which is Loss) the training loss is decreasing but the validation starts to increase. That’s because it sort of peaks at about 150. The same goes for the acc (accuracy).</p>
<pre class="r"><code>history &lt;- model%&gt;%
  fit(training,
      trainlabels,
      epoch = 200,
      batch_size = 32,
      validation_split = .2)
plot(history)</code></pre>
<p><img src="/post/Keras_CTG/script_files/figure-html/unnamed-chunk-10-1.png" width="672" /> <br></p>
<div id="evaluate-on-test-data" class="section level4">
<h4>Evaluate on Test Data</h4>
<p>So on this section I am going to test the model on never before seen data. As you can see the accuracy was around 85%, which is pretty good. I’ll take those odds.</p>
<pre class="r"><code>model %&gt;%
  evaluate(test, testlabels)</code></pre>
<pre><code>## $loss
## [1] 0.4245414
## 
## $acc
## [1] 0.854063</code></pre>
<p><br></p>
</div>
<div id="predictions" class="section level4">
<h4>Predictions</h4>
<p>In this section I am going to run a probability prediction. I will then run a class prediction where we will look at a confusion matrix. Then. I will tie this all together with a cbind function so we can see where we went wrong/right.</p>
<pre class="r"><code>prob &lt;- model%&gt;%
  predict_proba(test)</code></pre>
<p><br></p>
</div>
<div id="confusion-matrix" class="section level4">
<h4>Confusion Matrix</h4>
<p>We can see that it’s predicting very well on 0’s but not so well on 1 and 2’s. This is an imbalanced Data set so that could be part of the problem. I’ll have to look at how I could better balance it. No time today.</p>
<pre class="r"><code>pred &lt;- model%&gt;%
  predict_classes(test)

table(Predicted = pred, Actual = testtarget)</code></pre>
<pre><code>##          Actual
## Predicted   0   1   2
##         0 430  36  11
##         1  28  56   9
##         2   2   2  29</code></pre>
<p><br></p>
</div>
<div id="tie-it-all-together" class="section level4">
<h4>Tie it all together</h4>
<p>So here we can see line by line which ones we properly classified and which one’s we didn’t. If this was a real dataset we could dive down and see what’s going on with those data points.</p>
<pre class="r"><code>options(scipen = 999)
tbl &lt;- cbind(prob, pred, testtarget)
head(tbl, 10)</code></pre>
<pre><code>##                                           pred testtarget
##  [1,] 0.99275666 0.006889976 0.0003534281    0          0
##  [2,] 0.97643775 0.021933224 0.0016290600    0          0
##  [3,] 0.97948724 0.017532421 0.0029802755    0          0
##  [4,] 0.09469504 0.424739331 0.4805656075    2          2
##  [5,] 0.09469504 0.424739331 0.4805656075    2          2
##  [6,] 0.94440216 0.035695888 0.0199019369    0          1
##  [7,] 0.98642391 0.011996863 0.0015792544    0          0
##  [8,] 0.98893309 0.009776745 0.0012901857    0          0
##  [9,] 0.98239464 0.015503109 0.0021022658    0          0
## [10,] 0.98594809 0.013244435 0.0008075052    0          0</code></pre>
<p><br></p>
</div>
<div id="conclusion" class="section level4">
<h4>Conclusion</h4>
<p>All in all this model outperformed the Random Forest that I did in a previous blog. The ease of use was impressive considering the API and its power. I spent about 40 minutes building it out. The biggest barrier to these Deep Learning Neural Networks is trying to explain it to non-technical people (myself included). The concepts are very difficult and abstract. But like I said previously. I’m no mathmetician. But if I can prove the model works I’m fine with that – for now.</p>
<p>Next blog I am going to go over the Mnist dataset where we user Keras to classify hand written digits.</p>
<p>Thanks for coming by.</p>
<p>cs</p>
</div>
</div>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/supervised-learning" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">supervised learning</a>
   </li>
  
   <li class="list">
     <a href="/tags/caret" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">caret</a>
   </li>
  
   <li class="list">
     <a href="/tags/machine-learning" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">machine learning</a>
   </li>
  
   <li class="list">
     <a href="/tags/models" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">models</a>
   </li>
  
   <li class="list">
     <a href="/tags/keras" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">keras</a>
   </li>
  
   <li class="list">
     <a href="/tags/tutorial" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">tutorial</a>
   </li>
  
   <li class="list">
     <a href="/tags/tensorflow" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">tensorflow</a>
   </li>
  
</ul>
<div class="mt6">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "www-shockleysblog-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </main>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/post/glmnet/glmnet/">What?  Hypertune Using glmnet and Caret by Max Kuhn?  Pass it along.</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/randomforest/rfscript/">Complete Review of the Random Forest Package</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/roc/roc/">The ROC Curve - Is it a Mine or a Rock? - Pick your Sensitivity</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/showdown/showdown/">Showdown:  Random Forest vs Regression on EPA MPG Dataset</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/kmeans/kmeans/">Can the k means algorithm correctly identify a flower by its petal length and width alone?</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/weather_post/mkdown/">How many sunny days are followed by cloudy days in Seattle on any given year?</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/website/rvest_tables_tutorial/">Tutorial on Web Scraping (Basic) - Wiki Tables</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/regex/untitled/">To Regex or to Not?</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/melt/melt/">Why Melt and Cast When You Can Recast?</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="/" >
    &copy; 2018 Chris&#39;s Data Blog
  </a>
    <div>


  <a href="fb.me/astronomerforfun" class="link-transition facebook link dib z-999 pt3 pt0-l mr2" title="Facebook link">
    <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

  </a>







</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
